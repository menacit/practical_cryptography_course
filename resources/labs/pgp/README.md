<!--
SPDX-FileCopyrightText: © 2023 Menacit AB <foss@menacit.se>
SPDX-License-Identifier: CC-BY-SA-4.0
X-Context: Practical cryptography course - PGP and HSM lab
-->

# Practical cryptography course - PGP and HSM lab

## Scenario description
After the last widely publicized scandal (why are people discussing obvious crimes over email?!),
Credit Examplé finally decided to roll-out end-to-end encryption (E2EE) tools to all its regional
managers and C-level staff.  
  
The tools are however not yet widely used/understood, as your predecessor (who were suppose to
write documentation/HOWTOs) forwarded all company secrets to WikiLeaks and fled to ~~Ecuador~~
Sealand. Since you're the newest member of the security team (and not yet DDoS'ed by meetings),
the task has fallen into your lap.  
  
There shall be no prosperity without privacy!


## Learning objectives
Practical knowledge of OpenPGP and HSMs for cryptographic operations.


## Lab overview
The lab consist of a shell script that generates keys and performs cryptographic operations, such
as encryption/decryption and signing/signature validation, for several "bot message recipients".
This script its dependencies are package as a container image and designed to be executed using
"[Docker Compose](https://docs.docker.com/compose/)".  
  
The student is not expected/required to perform any changes in the bot script, but rather utilize
it as "conversation partners" to gain practical experience with the OpenPGP tool suite
"[GnuPG](https://gnupg.org/)" (also known as simply "gpg").  
  
Several lab files/directories are shared with the recipient bot:
- "**recipient_certificates/**": Populated by script with OpenPGP certificates for bot recipients
- "**student_data/student.crt**": File populated by student containing their OpenPGP certificate
- "**student_data/messages/%file%.txt**": Cleartext messages read by the bot recipients
- "**student_data/messages/%file%.txt.pgp**": Encrypted/signed messages read by the bot recipients
- "**responses/%file%.txt.pgp**": Encrypted/signed message responses created by the bot recipients
  
All tools required to complete the assignment should be pre-installed on the student's lab system.


## Tasks

### Student key generation
Use the "gpg" utility to create a new OpenPGP key-pair. It should...
- Be valid for three years
- Use 2048 bit RSA for keys
- Have a "sub-key" configured for encryption
- Use a YubiKey for **key generation** and storage (including any sub-keys)
  
Once generated, export OpenPGP certificate ("public key") to "student\_data/student.crt".


### Configure touch policy
Use the "ykman" utility to configure touch/physical confirmation policy "Fixed" for the student's
signature/certification OpenPGP key.


### Bot key generation and trust 
Execute the command "docker compose up" to run the recipient bot script. Once completed
successfully, OpenPGP certificates generated by the bot should be available in the directory
"recipient\_certificates".  
  
Use the "gpg" utility to import the bot certificates into the student's keyring. Validate the
certificate fingerprints (based on log output from the "docker compose up" command) and configure
"marginal" trust in the recipient bot keys.


### Message encryption
Use the "gpg" utility to encrypt the content of "student\_data/messages/truth.txt" against all keys
generated by the recipient bot script. Save the encrypted message to
"student\_data/messages/truth.txt.pgp".  
  
Execute the "docker compose up" command and observe log output to validate that the message was
successfully decrypted by all bot recipients.


### Message signing and encryption
Use the "gpg" utility to encrypt and sign the content of "student\_data/messages/truth.txt" against
all keys generated by the recipient bot script. Save the signed and encrypted message to
"student\_data/messages/truth.txt.pgp".  
  
Edit "docker-compose.yml" and set the environment variable "VERIFY\_SIGNATURE" to "true".
Execute the "docker compose up" command and observe log output to validate that the message was
successfully decrypted and verified by all bot recipients.


### Message verification and decryption
Edit "docker-compose.yml" and set the environment variable "RESPOND\_TO\_MESSAGES" to "true".
Execute the "docker compose up" command and observe how each bot recipient creates a
signed/encrypted response message for "student\_data/messages/truth.txt.pgp".  
  
Use the "gpg" utility to decrypt and validate signatures for these response messages.


## Lab report/documentation
Each student should submit a lab report containing **at least** the following information:
- Documentation of which commands/options were used to complete the lab tasks
- Demonstration of how recipient bot behaves when encrypted/signed messages are invalid/not trusted
  
The lab report should be provided as a plain text file (".txt"), Markdown document or PDF file.
In addition to the report, all lab files that have been changed (scripts, configuration sets, etc.)
should be provided as a ZIP or GZIP archive.  
  
Send lab report and archive of changed files in an email to:  
[courses+crypto-pgp\_lab@%EMAIL_DOMAIN%](mailto:courses+crypto-pgp_lab@%EMAIL_DOMAIN%)


## Guidance and resources

### Running the message recipient bot
The recipient bot shell script is designed to be executed using Docker Compose. To run the bot,
execute the command "docker compose up" and observe the log output.  


### Usage of debug logging
The recipient bot shell script provides a logging function. If the environment variable
"LOG\_LEVEL" is set to "DEBUG", the script will include verbose debug messages in script output.
The environment variable is set/may be changed in the "docker-compose.yml" file.


### Usage of boolean bot options
Recipient bot behavior can be modified by changing environment variables "VERIFY\_SIGNATURE" and
"RESPOND\_TO\_MESSAGES" in the "docker-compose.yml" file. As environment variables may only be
specified as strings, the option values must be either "true" or "false" within quotes.


### Checking YubiKey status
In order to validate that a connect YubiKey is properly accessible by the student's lab system,
issue the following command and observe output:

```
$ ykman info
```

If the output does not contain any information about connected YubiKeys, issue the following
command and try again:

```
$ sudo systemctl enable --now pcscd.service
```


### Resetting YubiKey
The OpenPGP storage of the YubiKey can be wiped/reset. This will cause current keys/configuration
to be permanently deleted from the device. To initiate a reset, issue the following command
carefully:

```
$ ykman openpgp reset
```


### Physical touch for confirmation
The YubiKey supports different "touch policies" which can be used to require physical confirmation
(by touching the round "Y" button) before performing cryptographic operations, such as signing and 
decryption.  
  
If a tool such as GnuPG seems to wait/hang, it may be due to the YubiKey requiring physical
confirmation - in these cases, the round "Y" button on the YubiKey blinks.


### Links
- [Environment variable HOWTO guide](https://www.cyberciti.biz/faq/set-environment-variable-linux/)
- [George Wood - GPG tutorial](https://gwood.dev/blog/2021/10/gpg-tutorial-command-line/)
- [Yubico - Using YubiKey with OpenPGP](https://support.yubico.com/hc/en-us/articles/360013790259)
- [Stefan Moser - "GnuPG for daily use"](https://moser-isi.ethz.ch/gpg.html)
- [The GNU Privacy Handbook](https://gnupg.org/gph/en/manual.html)
